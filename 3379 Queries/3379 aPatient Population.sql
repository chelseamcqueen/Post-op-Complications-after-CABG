--Patient Population

CREATE VIEW qwu6617.Charles3379 AS
SELECT
fp.Patient_DW_Id
,fp.Company_Code
,fp.Coid
,fp.Admission_Date
FROM EDWCDM_Views.Fact_Patient fp

INNER JOIN EDWCL_Views.Person_CL p
ON fp.Patient_Person_DW_Id = p.Person_DW_Id

INNER JOIN EDW_Pub_Views.Fact_Facility ff
ON fp.Coid = ff.Coid
AND ff.Division_Code in('00018','00023','00026') --Code for division
AND ff.LOB_Code = 'HOS' --Code for hospital
AND ff.COID_Status_Code = 'F' --Code for active facilities (i.e. not sold/closed)

	
INNER JOIN EDWCDM_PC_Views.Patient_Procedure PP   
ON	PP.Patient_DW_Id = FP.Patient_DW_Id 
AND	PP.COID=FP.COID
AND    PP.Procedure_Mapped_Code <> 'Y'
AND PP.Procedure_Code IN(
'02100AF',
'021009F',
'02100ZF',
'02104AW',
'021049W',
'02104KW',
'02100AW',
'021009W',
'02100KW',
'02100JW',
'021008W',
'02104A3',
'0210493',
'02104K3',
'02100A3',
'0210093',
'02100K3',
'02100J3',
'02100Z3',
'02104Z3',
'0210083',
'02103D4',
'02104D4',
'02100A9',
'02104A9',
'0210099',
'0210499',
'02100K9',
'02104K9',
'02100J9',
'0210089',
'0210489',
'02100Z9',
'02104Z9',
'02100A8',
'02104A8',
'0210098',
'0210498',
'02100K8',
'0210488',
'02100Z8',
'02104Z8',
'021049C',
'02100KC',
'02104KC',
'021008C',
'02100AC',
'021009C',
'02100ZC',
'02104ZC',
'02114AF',
'02110AF',
'021109F',
'02114AW',
'021149W',
'02110AW',
'021109W',
'02110KW',
'021108W',
'02114A3',
'0211493',
'0211483',
'02110A3',
'0211093',
'02110K3',
'0211083',
'02110Z3',
'02114Z3',
'02113D4',
'02114D4',
'02110A9',
'02114A9',
'0211099',
'0211499',
'02110K9',
'0211489',
'02110Z9',
'02114Z9',
'02110A8',
'0211098',
'0211498',
'02110K8',
'0211088',
'02110Z8',
'02114Z8',
'021149C',
'02110AC',
'021109C',
'02110ZC',
'02114ZC',
'02120AF',
'021209F',
'02120KF',
'02124AW',
'021249W',
'02120AW',
'021209W',
'02120KW',
'021208W',
'02124A3',
'0212493',
'02120A3',
'0212093',
'02120K3',
'02120J3',
'0212083',
'02120Z3',
'02124Z3',
'02123D4',
'02120A9',
'0212099',
'0212499',
'02120K9',
'0212089',
'02120Z9',
'02124Z9',
'02120A8',
'0212098',
'02120K8',
'02120Z8',
'02120AC',
'021209C',
'02120ZC',
'02130AF',
'021309F',
'02134AW',
'021349W',
'02134KW',
'02130AW',
'021309W',
'02130KW',
'02134A3',
'0213493',
'02130K3',
'0213483',
'02130A3',
'0213093',
'02130J3',
'02130Z3',
'02134Z3',
'02130A9',
'02134A9',
'0213099',
'0213499',
'02130K9',
'0213089',
'02130Z9',
'02134Z9',
'0213098',
'02130Z8',
'02134Z8',
'02130AC',
'02130KC',
'021309C'
		) 
WHERE fp.Admission_Date BETWEEN '2018-01-01' AND '2020-01-01' --update date
AND fp.Discharge_Date BETWEEN  '2018-01-01' AND '2020-01-01'  --update date
AND ((Cast((Cast((fp.Admission_Date(Format'YYYY-MM')) AS CHAR(7)) || '-01') AS DATE) - Cast((Cast((p.Person_Birth_Date(Format'YYYY-MM')) AS CHAR(7)) || '-01') AS DATE))/365) >44
AND fp.Company_Code='H'
AND fp.final_bill_date <> '0001-01-01'
AND fp.final_bill_date IS NOT NULL
/*AND fp.Patient_Type_Code_Pos1 = 'I' */

GROUP BY 1,2,3,4