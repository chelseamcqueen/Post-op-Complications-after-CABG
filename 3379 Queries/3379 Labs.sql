--Charles3379 Labs

SELECT
	fp.Coid AS HospID
	,Substr(Cast(Cast(Trim(OTranslate(reg.Medical_Record_Num,'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' ,'')) AS INTEGER) + 135792468 + Cast(fp.Coid AS INTEGER) + 1000000000000 AS CHAR(13)),2,12) AS PtID
	,Cast((reg.Patient_DW_ID (Format '999999999999999999')) + 135792468 + Cast(fp.Coid AS INTEGER)AS DECIMAL(18,0)) AS AdmtID
	,CPPS.Specimen_Collection_Date - fp.Admission_Date AS Rel_Coll_Date
	,CPPS.Specimen_Collection_Time AS Coll_Time
	,CPPR.Result_Verify_Date - fp.Admission_Date AS Rel_Final_Report_Day
	,CPPR.Clinical_Proc_Num AS Proc_Num
	,RCTP.Clinical_Proc_Mnemonic_CS AS Proc_Mnem  
	,RCTP.Clinical_Proc_Name AS Proc_Name    
	,CPPR.Result_Answer_Text AS Result_Answer_Text
	,CPPR.Result_Normal_Range_Text AS  Result_Normal_Range_Text
	,CPPR.Result_UOM_Amt AS UOM
	,RCTP.Clinical_Proc_EMR_ID AS Clinical_Proc_EMR_ID
	,ncm.Standard_Code_Text AS Loinc_Code
	,lnc.LONG_NM AS Loinc_Code_Desc
FROM EDWCDM_Views.Fact_Patient fp

INNER JOIN qwu6617.Charles3379GI pop		--update pop
	ON fp.Patient_DW_Id = pop.Patient_DW_Id
	AND fp.Company_Code = pop.Company_Code
	AND fp.Coid = pop.Coid

INNER JOIN EDWCL_Views.Clinical_Registration reg
	  ON fp.Patient_DW_Id = reg.Patient_DW_Id
	AND fp.CoID = reg.CoID
	AND fp.company_code = reg.company_code   

INNER JOIN EDWCL_VIEWS.Clinical_Patient_Proc_Specimen CPPS
	ON fp.Patient_DW_Id = CPPS.Patient_DW_Id
	AND fp.Company_Code = cpps.Company_Code
	AND fp.Coid = cpps.Coid

INNER JOIN EDWCL_VIEWS.Clinical_Patient_Proc_Result CPPR
	ON CPPR.Patient_DW_Id = CPPS.Patient_DW_Id
	AND CPPR.Specimen_URN=CPPS.Specimen_URN
	AND cppr.company_code = cpps.company_Code
	AND CPPR.COID = CPPS.COID
	AND CPPR.Clinical_System_Module_Code='LAB'
	AND CPPR.Result_Verify_Date BETWEEN '2016-01-01' AND Current_Date	--UPDATE BEGINNING DATE FOR POP

INNER JOIN EDWCL_VIEWS.Ref_Clinical_Test_Procedure RCTP
	ON CPPR.COID = RCTP.COID
	AND CPPR.Clinical_Proc_Num = RCTP.Clinical_Proc_Num

LEFT JOIN EDWCL_Views.Ref_Clin_Test_Proc_Nomen tpn
	ON rctp.COID = tpn.COID
	AND rctp.Clinical_Proc_Num = tpn.Clinical_Proc_Num

LEFT JOIN EDWCL_Views.Ref_Nomenclature_Code_Map ncm
	ON tpn.COID = ncm.COID
	AND tpn.Nomenclature_Code = ncm.Nomenclature_Code
	AND ncm.Standard_Code_Type = 'LOINC'
	AND ncm.Standard_Code NOT  LIKE '%IMO%'
	AND ncm.Active_Ind = 'Y'

LEFT JOIN EDWCDM_Views.RSLT_CD lnc
	ON ncm.Standard_Code_Text = lnc.RSLT_CD
	AND VLD_TO_TS = '9999-12-31 00:00:00'

WHERE Proc_Mnem IN(
'PW ADP COUNT',
'CREATII',
'AaDO2',
'A-aDO2',
'AaDpO2',
'BASE LINE PLT',
'PW BASELINE',
'POCCL',
'CL/ABG',
'CL/VBG',
'ISCL',
'CO2CTA',
'POCTCO2CTA',
'FIO2A',
'ETCO2',
'PFRATIO',
'ABG PO2FIO2R',
'BGFIO2',
'FIO2',
'BG FIO2',
'AFIO2',
'FIO2V',
'FIO2POXM',
'MVFIO2',
'ABG18FI',
'PCO2A',
'ABG2PCO2',
'ZPCO2ISTAT',
'POCTPCO2A',
'PCO2I',
'FIO2X',
'FIO2PCE',
'PO2I',
'POT',
'KA',
'ABGK',
'POTHRT',
'ABGNA',
'NAA',
'NABGHRT',
'TCPCO2A',
'TCO2A',
'PHA',
'TEMPA',
'ABGTCO2',
'CO2ATOT',
'TCO2I',
'TCO2E',
'CVOR PHA',
'PHAX',
'ABG PH',
'CVOR ABG PH',
'PHAP',
'PH',
'POCPHA',
'PHA BG',
'PHABG',
'POCPH',
'PHPOC',
'POCTPH',
'ABG PH CORRECTD',
'ABG1PH',
'PHACOR',
'ISPHACOR',
'PHC',
'PHACORP',
'PHAI',
'ISAPH',
'CpH',
'PHI',
'BGLACT',
'AA.',
'POCTCLI',
'CLNPT',
'ABGTHB',
'FIO2 IS',
'IFIO2',
'ABG PCO2',
'CVOR PCO2A',
'ABG PCO2 CORRCT',
'RADPHA',
'CG8PHA',
'ABGPH',
'ABG K',
'ABG NA',
'ABG TCO2',
'TCO2',
'THBACO',
'NABG',
'CO2A',
'ISFIO2',
'ABG COOX THGB',
'ABLPH',
'PHPOCE',
'ZPHAISTAT',
'POCTPHA',
'PHRT',
'BGPH',
'PCO2AI',
'ISPO2FIO2',
'BUNI',
'ISAPO2FIO2',
'CLPOC',
'CO2I',
'CREATBED',
'POCCREATI',
'PHAR',
'GLUMON',
'KI',
'NAI',
'TCO2VI',
'PCO2VI',
'POCPHV',
'LACTHOLD',
'CLPOCE',
'ETCO2POC',
'MVBGFI',
'FIO2MV',
'O2LPM',
'LACT1',
'BG K',
'BG NA',
'CHLORU',
'BGK',
'BGNA',
'PA-FIO2',
'PFA',
'PCO2',
'PF',
'POCPF',
'PFR',
'POCBUN',
'BUNPOCE',
'ISBUN',
'POCTBUN',
'BUNPOC',
'THBCO',
'POCTPHACOR',
'ISAPHC',
'LACTSEPSIS',
'PHCOR',
'CVOR PHCOR',
'ISTATBUN',
'POCBUNI',
'IBUN',
'POC BUN',
'BUNPOCT',
'BUN POC',
'POC-ISBUN',
'BUNP',
'POCB',
'POCCREAT',
'POCPHCOR',
'CA',
'CAL',
'SPMCA++',
'PTHINTCA',
'CACAL',
'CCA',
'CAION',
'CAI',
'CA-I',
'CAIT',
'IPH',
'CBG2PCO2',
'POCCO2',
'CO2',
'BICARB',
'WB CO2',
'CO2 NP',
'CO2 POC',
'CO2POC',
'ABGHGB',
'HGB/ABG',
'THBA',
'THB',
'PCO2C',
'BGPHPOC',
'CLWB',
'CRT',
'POC CL',
'POCCHLOR',
'POCC',
'CLPOCT',
'CLPOC1',
'WBCL',
'CLA',
'ABGCL',
'CLBGHRT',
'CLBG',
'CL*',
'CLABG',
'RTCL',
'CLI',
'CL',
'POCTCL',
'WB CL',
'ICL',
'ISTATCL',
'CLP',
'ABG CL',
'BG CL',
'CREATI',
'CREAABG',
'POCTCREA',
'CREATPOC',
'CREAPOC',
'POCCREA',
'CREAT POC',
'CREATPOCE',
'ISCREA',
'CREPOC',
'POCECREAT',
'ICREAT',
'ISTATCREAT',
'POC CREA',
'POCICR',
'POCCT',
'POCCREATED',
'POC-ISCREA',
'CREATPOCT',
'CRPOC',
'BGCL',
'CO2CT',
'POCTCO2',
'POCTCO2I',
'PLTBLUE',
'PLTOR',
'PLT NC',
'PLTEST',
'MVPH',
'POCGPH',
'PHCA',
'PHICA',
'PHPOCCOR',
'TEMPAP',
'ABG COOX HHB',
'POCHGB',
'POCTHGB',
'POC-ISHGB',
'PCO2ACOR',
'POCTPCO2ACOR',
'SPMPH',
'PO2ACOR',
'PCO2COR',
'ISPCO2COR',
'PCO2VCOR',
'CPCO2PCE',
'PHTEMP',
'PO2VCOR',
'PCO2POCCOR',
'NACORRECT',
'NACORR',
'CWBC',
'CORRWBC',
'CREAT',
'CREA',
'CREATININE',
'CRESERUM',
'CREATFENARFI',
'CREATB',
'CREATT',
'GFRCREAT',
'CREATSE',
'CVOR ABG PCO2',
'ZZPOCPHCOR',
'CVOR K',
'CVOR NA',
'HGBTRANS',
'ETCO2A',
'PH IS',
'TCPH',
'GLUAVERAGE',
'EAGCALC',
'ESTIM AVE GLU',
'EAG',
'HGEAG',
'EST AVG GLU',
'ETPCO2',
'eAG MG.DL',
'FER',
'FN',
'FERR',
'PFRATIOPCE',
'PFRATIOX',
'ZZPOCFIO2',
'POCFIO2',
'POCVFIO2',
'POCVPF',
'FIO2POC',
'VFIO2',
'VBG18FI',
'VBGFIO2',
'PFRATI',
'BGPFRAT',
'PFRAT',
'ISAFIO2',
'PAO2FIO2',
'SPMPFRATIO',
'POCFIO2A',
'FIO2CO',
'SPMFIO2',
'COHBGFFIO2',
'SPMLACT',
'LACT2',
'LACTIC2',
'LACTIC',
'LACREF2',
'POCTLACTICA',
'LACR',
'ZZLACPOC',
'FENAC',
'PLTSCAN',
'GLUWB',
'eAVGGLUCOSE',
'GLUI',
'GLUPOC',
'GLUA',
'BG GLU',
'CVOR GLU',
'IG',
'BGGLU',
'ZGLUDEV',
'GLUCPOC',
'BSGLUR',
'POC-ISGLUC',
'POC-GLUC',
'ABG GLUCOSE',
'ABGGLUC',
'SPMGLU',
'GLU*',
'GLU',
'GLUC',
'ABGGLU',
'GLUF',
'GLU NP',
'ISTATGLU',
'POC GLU',
'VBG GLUCOSE',
'GLUPOCT',
'POCTGLU',
'ISGLU',
'EAG(c)',
'MBG',
'MEANBLDGLU',
'MBGLU',
'MBGCALC',
'ESTGLU',
'THBCOV',
'AHB',
'ABG6HB',
'HGBBGF',
'HGBTC',
'HHb',
'POCTHBA',
'HGBNPT',
'THBABGI',
'HGBI',
'ABLHGB',
'HGBPOC',
'SPMHB',
'THG',
'ORHB',
'BGHGB',
'O2 SAT HGB',
'GEMTHB',
'POCAVTHGB',
'ABG HHB',
'CHGBR',
'POCTHBCO',
'HGBPOCE',
'HGBABG',
'HEMOCUEHGB',
'HGBPOCT',
'POCHGBI',
'HGB NP',
'HGBMCV',
'HGBCBC',
'HGB',
'HGBMETHGB',
'HGBT',
'HGBCT',
'HGBNC',
'POC HGB',
'HGBCALC',
'ISHGB',
'ISTATCHGB',
'CG8HGB',
'HGBRT',
'CALC HGB POC',
'ZHBGISTAT',
'HGBA',
'THBV',
'FIO2I',
'IONCA',
'CAIABG',
'ISCAI',
'CAIONA',
'ICAL/ABG',
'CAIONBG',
'CAIONR',
'ISAPCO2C',
'SEPSIS TIMER',
'LACPOCE',
'ISAPCO2',
'ISATCO2',
'BUN',
'ABGCA',
'HGBOT',
'ISTAT-CO2',
'ISTATCO2',
'CHLOR',
'ABGFIO2',
'FIO2AP',
'POCGLU',
'GLUMONR',
'ABGCAI',
'ICRT',
'LACARTPOC',
'LA REFLEX1',
'LA REFLEX 1',
'IPCO2',
'FIO2VP',
'IK',
'ISTATK',
'INA',
'ISTATNA',
'ITCO2',
'ISTATTCO2',
'LACTREFLEX',
'ISVPCO2',
'ISVTCO2',
'POCGLUIS',
'MVBGtHB',
'PCO2AP',
'PCO2VP',
'KP',
'NAP',
'TCO2AP',
'TCO2VP',
'KPOCE',
'LACTREF',
'LACTATEA',
'GEMLAC',
'LACT4',
'LACTNR',
'LACT',
'LACT3',
'LACT6',
'LACT5',
'LACTPOC',
'ABLLAC',
'LAC',
'LACREF1',
'POC LAC',
'ABG LACTIC',
'LACTAI',
'BG LAC A',
'BGLAT',
'ISALAC',
'LART',
'LACTNPT',
'LACPOC3',
'POCLAC',
'POCLACV',
'RTLAC',
'LACTARTRP500',
'BGLAC',
'ISLAC',
'ISTATLRV',
'ILACT',
'LACTATEI',
'LACTVENRP500',
'WB LA',
'LACPOC',
'LAPOC',
'POCLACTI',
'POCGLACT',
'LACTPOST',
'ABGLAC',
'LACTIC ACID',
'LA',
'LACTIC 2',
'LACTIC2HR',
'LACREF',
'LACTR',
'POCLACTE',
'POCTLACTIC',
'ISVLAC',
'LACTP',
'POCCA',
'MG',
'MAG',
'MGPROT',
'THBMV',
'PHGBVBG',
'POCGLUI',
'HBP',
'IHGB',
'VBGHGB',
'VBGTHB',
'VBG6tHB',
'CVOR HGB',
'RADHGB',
'MVTHB',
'MVPCO2',
'MSUCRYFL',
'PCO2MV',
'PBNP',
'POCTHBV',
'PAO2',
'ABGPCO2',
'ABLPCO2',
'PCO2AR',
'PCO2V',
'SPMPCO2',
'POCPCO2A',
'PCO2ABG',
'PCO2A BG',
'PCO2PCE',
'PCO2 IS',
'PCO2POC',
'PCO2Temp',
'PCO2VBG',
'PCO2MXDV',
'ZFIO2ISTAT',
'PE',
'PLTE',
'PLT',
'PLTF',
'PLTCNT',
'PO2PCE',
'BG PF RATIO',
'FIO2ECMOA',
'POCPCO2',
'RTICA',
'CAIN',
'CL NP',
'CVOR CL',
'POC-ISCL',
'POC CO2',
'POCSATCO',
'PCO2ACORP',
'PCO2VCORP',
'POCTFIO2A',
'FIO2AL',
'POC GLUC',
'POCISGLU',
'GLUCPOCT',
'GLUPOC2',
'WBGLU',
'GLU/VBG',
'GLUP',
'PGLU',
'GLUPOC1',
'WB GLU',
'GRT',
'POCTGLUI',
'CG8GLU',
'RADGLU',
'POCK',
'GEMK',
'LACTATEV',
'VBG LACTIC',
'POCNA',
'GEMNA',
'GEMPCO2',
'CG8PCO2A',
'RADPCO2A',
'POCPCO2COR',
'ZZPOCPCO2COR',
'POCGPCO2',
'POCPCO2V',
'RADPCO2V',
'CG8PCO2V',
'RADK',
'POC K',
'CG8K',
'POCP',
'POCGK',
'POC NA',
'CG8NA',
'RADNA',
'POCS',
'POCGNA',
'POCNAWB',
'POCO2',
'POCTCO2A',
'CG8TCO2A',
'POCTCO2V',
'CG8TCO2V',
'TCO2POC',
'FIO2AI',
'POCVPC02',
'POCVPCO2COR',
'FIO2VI',
'VBG CL',
'POC-ISK',
'POC-ISNA',
'POC-ISTCO2',
'PCO2POCT',
'TCO2BGPOC',
'FIO2IS',
'POCTK',
'POCTNA',
'POCTPCO2',
'POCPCO2I',
'KPOCT',
'NAPOCT',
'POCTTCO2',
'TCO2POCT',
'GLUCPCE',
'ZGLUISTAT',
'ABLGLU',
'GLU/ABG',
'KPOC',
'NAPOC',
'ABLK',
'ZKISTAT',
'K*',
'BGKR',
'K/VBG',
'K/ABG',
'KABG',
'K',
'KT',
'SPMK+',
'ISK',
'POCTKI',
'URK',
'KBD',
'KNPT',
'K NP',
'K POC',
'POTPOC',
'POCKI',
'KU',
'POTU',
'KWB',
'WB K',
'PRT',
'PLTCBC',
'PLTB',
'PLAVPLT',
'PLTASACNT',
'TPROTURAN',
'PLCT',
'PLTCT',
'PLTT',
'PLTS',
'PLTA',
'PLG',
'PLTEST*',
'MPLTEST',
'PLTESTCV',
'PLTD',
'RUNA',
'GLUNPT',
'RTGLUC',
'RTK',
'RTNA',
'ZNAISTAT',
'NA*',
'ABLNA',
'NA/VBG',
'BGNAR',
'NA/ABG',
'NA',
'SPMNA+',
'ISNA',
'POCTNAI',
'URNA',
'STNAAU',
'NAB',
'NANPT',
'NA NP',
'NA POC',
'NAPOCE',
'POCNAI',
'NAFENARFI',
'NAU',
'UASPOTNA',
'NAU24',
'NAUFENARFI',
'SODU',
'NAWB',
'NA24U',
'UR NA RAND',
'UNAR',
'NAABG',
'WB NA',
'SRT',
'SPMTCO2',
'TCO2PCE',
'TCO2CALC',
'TCO2 IS',
'IST CO2T',
'TCPCO2',
'MVTCPCO2',
'CVOR PCO2COR',
'CpCO2',
'PO2COR',
'CO-OX tCO2',
'TCO2IM',
'POCCO2I',
'TCO2V',
'HGB/VBG',
'TCCO2',
'TCMCO2A',
'RTGLU',
'FLGLU',
'GLUFL',
'POCGLUC',
'ACCG',
'VBG COOX THGB',
'PHVI',
'ISVPH',
'PHVP',
'CG8PHV',
'RADPHV',
'POCPHI',
'PHV',
'VPH',
'CVOR VBG PH',
'NAUNCAL',
'CL POC',
'POCG',
'POCGLUM',
'POC GLU PT TYPE',
'KRAN',
'NA24T',
'NAUC',
'NAULEV',
'NARAN',
'NAURATE',
'WB BUN',
'ABGCAIT',
'CAIWB',
'POCGLUPT',
'POC GLU SOURCE',
'POCGLUST',
'POCGLUUS',
'URKR',
'UNAUR',
'USUCRYS',
'URNAR',
'WB CREAT',
'PHVBG',
'POCVPH',
'CVOR PHV',
'VBG PH',
'VBGPH',
'VBGETCO2',
'FIO2MXDV',
'O2 SAT FIO2',
'VBG1PH',
'PHVCOR',
'TCPCO2V',
'CO2VTOT',
'VCO2',
'VBGAaDO2',
'POCGLUU',
'SPMCL',
'POCTFIO2',
'FIO2ECMOV',
'FIO2VL',
'CVOR PCO2V',
'VBG PCO2',
'VBG PCO2 CORRCT',
'POCVPHCOR',
'VTEMP',
'VBG K',
'VBG NA',
'TEMPV',
'PHVCORP',
'VBG PH CORRECTD',
'VPCO2',
'VBG2PCO2',
'VBGPCO2',
'TCPHV',
'WBC',
'WBCED',
'CBC WBC',
'WBCCT',
'WBCC',
'WBCR',
'WBCEST',
'POCCLI',
'POCTGLUC',
'WBK',
'WBNA')

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15

